<div class="topDiv clr-col">
  <div
    class="clr-row clr-justify-content-center"
    [class.block-clicks]="!editable"
  >
    <div class="clr-col clr-col-lg-10 clr-col-xl-8 sectionCol">
      <clr-alert
        [clrAlertClosable]="false"
        [clrAlertType]="'warning'"
        *ngIf="submitted"
        [clrAlertIcon]="'warning-standard'"
      >
        <clr-alert-item>
          <span class="alert-text">
            This report has been marked complete. You can still edit it, but
            consider creating a duplicate instead.
          </span>
          <div class="alert-actions">
            <clr-dropdown>
              <button class="dropdown-toggle" clrDropdownTrigger>
                Actions
                <clr-icon shape="caret down"></clr-icon>
              </button>
              <clr-dropdown-menu clrPosition="bottom-right">
                <a
                  (click)="duplicateCurrentReport()"
                  class="dropdown-item"
                  clrDropdownItem
                  >Duplicate this report</a
                >
              </clr-dropdown-menu>
            </clr-dropdown>
          </div>
        </clr-alert-item>
      </clr-alert>
      <h1>
        {{ (page$ | async)?.title }}
      </h1>
      <hr />
      <div *ngFor="let section of currentSections">
        <datagrid-section
          *ngIf="isDatagrid(section); else simpleInput"
          [interface]="section"
          (sectionChanged)="setSection(section, $event)"
        >
        </datagrid-section>
        <ng-template #simpleInput>
          <simple-input
            [interface]="section"
            (sectionChanged)="setSection(section, $event)"
          ></simple-input>
        </ng-template>
      </div>
      <div class="clr-col-md-6 clr-offset-md-3 clr-align-self-end">
        <clr-icon shape="help-info"></clr-icon
        ><em>Try the buttons below to continue the report.</em>
      </div>
      <div style="height: 48px;"></div>
    </div>
  </div>
  <clr-modal [(clrModalOpen)]="submitConfirmationVisible">
    <h3 class="modal-title">All finished?</h3>
    <div class="modal-body">
      <clr-alert
        *ngIf="!reportFullyComplete"
        [clrAlertType]="'warning'"
        [clrAlertClosable]="false"
      >
        <clr-alert-item>
          <span class="alert-text">
            Heads up: not all pages have been marked as complete.
          </span>
        </clr-alert-item>
      </clr-alert>
      <hr />
      <b>Marking a report as complete</b> indicates that all data inside should
      be considered final. You can still edit the report after it's been marked
      complete.
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-outline"
        (click)="cancelSubmitReport()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="submitReport()"
        [clrLoading]="submitButtonState"
      >
        Mark as complete
      </button>
    </div>
  </clr-modal>
  <div
    class="alert alert-success"
    *ngIf="saveSuccessful"
    role="alert"
    style="
      position: fixed;
      bottom: 54px;
      left: 6px;
      width: 10rem;
      z-index: 1000;
    "
  >
    <div class="alert-items">
      <div class="alert-item static">
        <div class="alert-icon-wrapper">
          <clr-icon class="alert-icon" shape="check-circle"></clr-icon>
        </div>
        <span class="alert-text">Page saved</span>
      </div>
    </div>
  </div>
  <div class="stickybar clr-row">
    <div class="clr-col-8 clr-col-md-10">
      <div class="clr-row clr-justify-content-center clr-align-items-center">
        <button
          type="button"
          class="btn"
          [class.btn-primary]="saveStale"
          [class.btn-link]="!saveStale"
          aria-label="save page"
          [clrLoading]="saveButtonState"
          (click)="savePage()"
          title="Save current page"
          *ngIf="editable"
        >
          <clr-icon shape="floppy" [class.has-alert]="saveStale"></clr-icon>
          {{ saveTimeElapsed }}
        </button>
        <button
          type="button"
          class="btn btn-icon btn-link"
          aria-label="previous page"
          [disabled]="currentPageIndex < 1"
          (click)="goToPage(currentPageIndex - 1)"
        >
          <clr-icon shape="angle" dir="left"></clr-icon>
        </button>
        <clr-button-group *ngIf="(report$ | async)?.id">
          <clr-button
            [class]="getPageButtonClass(i)"
            *ngFor="let status of (report$ | async)?.pageStatuses; index as i"
            (click)="goToPage(i)"
          >
            <clr-icon
              shape="home"
              *ngIf="i < 1; else showPageNumber"
            ></clr-icon>
            <ng-template #showPageNumber>
              {{ i }}
            </ng-template>
            <clr-icon
              shape="check"
              *ngIf="pageComplete(i)"
              title="Marked complete"
            ></clr-icon
          ></clr-button>
        </clr-button-group>
        <button
          type="button"
          class="btn btn-icon btn-link"
          aria-label="next page"
          [disabled]="currentPageIndex > (report$ | async)?.pageCount - 2"
          (click)="goToPage(currentPageIndex + 1)"
        >
          <clr-icon shape="angle" dir="right"></clr-icon>
        </button>
        <button
          type="button"
          class="btn"
          aria-label="next page"
          (click)="confirmSubmitReport()"
          [class.btn-success]="reportFullyComplete"
          [clrLoading]="submitButtonState"
          *ngIf="editable"
        >
          Finish<clr-icon shape="step-forward-2"></clr-icon>
        </button>
      </div>
    </div>
    <div class="clr-col-4 clr-col-md-2" *ngIf="editable">
      <clr-toggle-container #markCompleteToggle>
        <label class="p6" style="margin-top: 0.3rem;">Mark this page:</label>
        <clr-toggle-wrapper>
          <input
            type="checkbox"
            clrToggle
            value="option1"
            name="options"
            [formControl]="markCompleteControl"
          />
          <label *ngIf="pageComplete(currentPageIndex); else incompleteLabel"
            >Complete</label
          >
          <ng-template #incompleteLabel>
            <label>Incomplete</label>
          </ng-template>
        </clr-toggle-wrapper>
      </clr-toggle-container>
    </div>
  </div>
</div>
